// pageBuilder.js
import { getPageDimensions } from '../formUtils/dpiUtils.js';
import { globalState } from '../../reactive/state.js';

function createFooter(pageIndex, totalPages) {
    const footer = document.createElement('footer');
    footer.className = 'page-footer';

    const leftSection = document.createElement('div');
    leftSection.className = 'footer-left';
    const formattedDateTime = new Date().toLocaleString();
    leftSection.innerHTML = `
        <p>Report Generated: ${formattedDateTime}</p>
        <p>Page ${pageIndex + 1} of ${totalPages}</p>
    `;

    const centerSection = document.createElement('div');
    centerSection.className = 'footer-center';
    centerSection.textContent = globalState.getState().reportTitle || 'Report Title';

    const rightSection = document.createElement('div');
    rightSection.className = 'footer-right';
    const userInfo = JSON.parse(localStorage.getItem('user')) || {};
    rightSection.innerHTML = `
        <p>Report Generated By: ${userInfo.fname || ''} ${userInfo.lname || ''}</p>
        <p>Created With: 911 Emerge-N-See Report Generator</p>
    `;

    footer.appendChild(leftSection);
    footer.appendChild(centerSection);
    footer.appendChild(rightSection);

    return footer;
}

// pageBuilder.js

export function renderPages(pages) {
    const reportContainer = document.getElementById('contentBody');
    if (!reportContainer) {
        console.error('Report container not found.');
        return;
    }

    reportContainer.innerHTML = ''; // Clear existing content

    const totalPages = pages.length;
    console.log(`Total Pages to render: ${totalPages}`);

    pages.forEach((page, pageIndex) => {
        const pageDiv = document.createElement('div');
        pageDiv.className = 'page';
        pageDiv.style.width = '816px'; // 8.5 inches * 96 DPI
        pageDiv.style.height = '1056px'; // 11 inches * 96 DPI
        pageDiv.style.position = 'relative';
        pageDiv.style.marginBottom = '20px'; // Space between pages
        pageDiv.style.pageBreakAfter = 'always'; // Ensure page breaks in print/PDF

        // Append each content to the page
        page.forEach((content, contentIndex) => {
            // Enhanced logging
            console.log(`Appending content to Page ${pageIndex + 1}, Content ${contentIndex + 1}:`, content, 'Instance of Node:', content instanceof Node);

            if (content instanceof Node) {
                pageDiv.appendChild(content);
            } else {
                console.error(`Content at Page ${pageIndex + 1}, Content ${contentIndex + 1} is not a Node:`, content);
            }
        });

        // Append footer to the page
        const footer = createFooter(pageIndex, totalPages);
        if (footer instanceof Node) {
            pageDiv.appendChild(footer);
            console.log(`Appended footer to Page ${pageIndex + 1}`);
        } else {
            console.error(`Footer for Page ${pageIndex + 1} is not a valid Node:`, footer);
        }

        reportContainer.appendChild(pageDiv);
    });

    console.log(`Rendered ${totalPages} pages.`);
}

export function scaleTableComponent(table, scaleRatio) {
    if (!table || !(table instanceof HTMLElement)) {
        console.error("Invalid or missing table component for scaling");
        return;
    }

    console.log("Scaling table component with scaleRatio:", scaleRatio);

    if (!table || !(table instanceof HTMLElement) || table.hasAttribute('data-scaled')) return; // Prevent double scaling

    table.setAttribute('data-scaled', 'true');

    // Scale header and row cells
    const headerCells = table.querySelectorAll("th");
    headerCells.forEach((headerCell, index) => {
        const computedStyles = getComputedStyle(headerCell);
        const baseFontSize = parseFloat(computedStyles.fontSize);
        const basePaddingTop = parseFloat(computedStyles.paddingTop);
        const basePaddingBottom = parseFloat(computedStyles.paddingBottom);

        if (baseFontSize) {
            headerCell.style.fontSize = `${parseFloat(baseFontSize * scaleRatio - (scaleRatio / 10)).toFixed(0)}px`;
        }
        if (basePaddingTop) {
            headerCell.style.paddingTop = `${parseFloat(basePaddingTop * scaleRatio - (scaleRatio / 10)).toFixed(0)}px`;
        }
        if (basePaddingBottom) {
            headerCell.style.paddingBottom = `${parseFloat(basePaddingBottom * scaleRatio - (scaleRatio / 10)).toFixed(0)}px`;
        }
    });

    const rowCells = table.querySelectorAll("td");
    rowCells.forEach((rowCell, index) => {
        const computedStyles = getComputedStyle(rowCell);
        const baseFontSize = parseFloat(computedStyles.fontSize);
        const basePaddingTop = parseFloat(computedStyles.paddingTop);
        const basePaddingBottom = parseFloat(computedStyles.paddingBottom);

        if (baseFontSize) {
            rowCell.style.fontSize = `${parseFloat(baseFontSize * scaleRatio - (scaleRatio / 10)).toFixed(0)}px`;
        }
        if (basePaddingTop) {
            rowCell.style.paddingTop = `${parseFloat(basePaddingTop * scaleRatio - (scaleRatio / 10)).toFixed(0)}px`;
        }
        if (basePaddingBottom) {
            rowCell.style.paddingBottom = `${parseFloat(basePaddingBottom * scaleRatio - (scaleRatio / 10)).toFixed(0)}px`;
        }
    });
}

export function applyColumnWidths(table, columnWidths) {
    const headerCells = table.querySelectorAll("th");
    const rowCells = table.querySelectorAll("tr");

    headerCells.forEach((headerCell, index) => {
        if (columnWidths[index]) {
            headerCell.style.width = `${columnWidths[index]}px`;
        }
    });

    rowCells.forEach((row) => {
        const cells = row.querySelectorAll("td");
        cells.forEach((cell, index) => {
            if (columnWidths[index]) {
                cell.style.width = `${columnWidths[index]}px`;
            }
        });
    });
}

export function captureColumnWidths(table) {
    const columnWidths = [];
    const headerCells = table.querySelectorAll("th");

    headerCells.forEach((headerCell) => {
        columnWidths.push(headerCell.offsetWidth);
    });

    return columnWidths;
}
